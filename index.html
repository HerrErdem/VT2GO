<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VT2GO – Power Distribution & Leitungsdimensionierung</title>

  <!-- MathJax für Formeln -->
  <script>
    window.MathJax = {
      tex: { inlineMath: [['\\(','\\)'], ['$', '$']] },
      options: { skipHtmlTags: ['script','noscript','style','textarea','pre','code'] }
    };
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    :root{
      --bg:#070b16;
      --panel: rgba(255,255,255,.04);
      --card: rgba(255,255,255,.035);
      --line: rgba(255,255,255,.10);
      --text:#eaf1ff;
      --muted:#b9c7e6;
      --accent:#6aa6ff;
      --accent2:#7ef0c4;
      --shadow: 0 12px 34px rgba(0,0,0,.42);
      --radius: 18px;
      --danger: rgba(255,120,120,.18);
      --ok: rgba(126,240,196,.12);
      --warn: rgba(255,196,120,.14);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      line-height:1.6;
      background:
        radial-gradient(1100px 520px at 12% -8%, rgba(106,166,255,.25), transparent 55%),
        radial-gradient(900px 520px at 92% 0%, rgba(126,240,196,.18), transparent 55%),
        linear-gradient(180deg, var(--bg), #040611 72%);
    }

    .wrap{ max-width: 1040px; margin: 0 auto; padding: 26px 18px 64px; }

    header{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 22px 22px;
      backdrop-filter: blur(7px);
    }
    .top{ display:flex; gap:16px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; }
    .brand{ display:flex; gap:12px; align-items:center; }
    .logo{
      width:46px;height:46px;border-radius: 16px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 14px 30px rgba(106,166,255,.22);
      flex: 0 0 auto;
    }
    h1{ margin:0; font-size: 26px; font-weight: 700; letter-spacing: .2px; }
    .claim{ margin:4px 0 0; color: var(--muted); font-size: 14px; font-weight: 400; max-width: 56ch; }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .chip{
      font-size:12px; color: var(--muted);
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding: 6px 10px; border-radius: 999px; white-space:nowrap;
    }

    .nav{ margin-top: 12px; display:flex; gap:10px; flex-wrap:wrap; }
    .btn{
      display:inline-block;
      padding: 8px 12px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      font-size: 13px;
      font-weight: 400;
      text-decoration:none;
    }
    .btn:hover{ background: rgba(255,255,255,.07); }

    main{ margin-top: 16px; display:grid; gap: 14px; }

    section{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px 18px;
    }

    h2{ margin:0 0 10px; font-size: 18px; font-weight: 700; }
    h3{ margin:14px 0 8px; font-size: 15px; font-weight: 700; }
    h4{ margin:10px 0 8px; font-size: 14px; font-weight: 700; }

    p{ margin: 10px 0; color: var(--text); font-weight: 400; }
    .muted{ color: var(--muted); font-size: 14px; font-weight: 400; }

    .grid-2{ display:grid; gap:14px; grid-template-columns: 1.15fr .85fr; }
    .grid-2 > .grid-full{ grid-column: 1 / -1; }
    @media (max-width: 860px){ .grid-2{ grid-template-columns: 1fr; } }

    .hero{
      border-radius: 16px; overflow:hidden; border: 1px solid var(--line);
      background: rgba(0,0,0,.22);
    }
    .hero img{ width:100%; display:block; }
    .caption{ padding:10px 12px; font-size: 13px; color: var(--muted); background: rgba(255,255,255,.03); }

    .callout{
      padding: 14px 14px; border-radius: 16px;
      border: 1px solid rgba(106,166,255,.30);
      background: rgba(106,166,255,.10);
    }
    .callout strong{ font-weight: 700; color: var(--text); }

    .list{ margin:10px 0 0; padding-left: 18px; color: var(--text); font-weight: 400; }
    .list li{ margin: 6px 0; }

    .formula{
      background: rgba(0,0,0,.25);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px 12px;
      margin: 12px 0;
      overflow-x:auto;
    }

    .two-cards{ display:grid; gap:14px; grid-template-columns: 1fr 1fr; }
    @media (max-width: 860px){ .two-cards{ grid-template-columns: 1fr; } }

    .kpi{ display:grid; gap:10px; grid-template-columns: 1fr 1fr; margin-top: 10px; }
    @media (max-width: 520px){ .kpi{ grid-template-columns: 1fr; } }
    .kpi .box{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding: 12px 12px;
    }
    .kpi .box .title{ font-size: 12px; color: var(--muted); margin:0 0 6px; font-weight: 400; }
    .kpi .box .value{ margin:0; font-size: 14px; font-weight: 400; color: var(--text); }

    footer{ margin-top: 16px; text-align:center; color: var(--muted); font-size: 13px; font-weight: 400; }

    /* Rechner UI */
    .formgrid{
      display:grid;
      gap:12px;
      grid-template-columns: 1fr 1fr 1fr;
    }
    @media (max-width: 860px){ .formgrid{ grid-template-columns: 1fr; } }

    .field{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding: 12px 12px;
    }
    .field label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin:0 0 6px;
    }
    .field input, .field select{
      width:100%;
      padding: 10px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: var(--text);
      font-size: 14px;
      outline:none;
    }
    .field input:focus, .field select:focus{
      border-color: rgba(106,166,255,.55);
      box-shadow: 0 0 0 3px rgba(106,166,255,.18);
    }
    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .action-btn{
      cursor:pointer;
      padding: 10px 14px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      font-size: 13px;
      font-weight: 400;
    }
    .action-btn:hover{ background: rgba(255,255,255,.07); }

    .resultgrid{
      display:grid;
      gap:12px;
      grid-template-columns: 1.2fr .8fr;
      margin-top: 12px;
    }
    @media (max-width: 860px){ .resultgrid{ grid-template-columns: 1fr; } }

    .status{
      border-radius: 16px;
      padding: 12px 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .status.ok{ background: var(--ok); border-color: rgba(126,240,196,.35); }
    .status.warn{ background: var(--warn); border-color: rgba(255,196,120,.35); }
    .status.bad{ background: var(--danger); border-color: rgba(255,120,120,.35); }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .small{ font-size: 12px; color: var(--muted); }
    .hr{ height:1px; background: rgba(255,255,255,.10); margin: 12px 0; border:0; }

    .tablelike{
      border:1px solid var(--line);
      border-radius: 14px;
      overflow:hidden;
    }
    .tablelike .row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      background: rgba(255,255,255,.02);
      border-top:1px solid rgba(255,255,255,.06);
    }
    .tablelike .row:first-child{ border-top:0; }
    .tablelike .k{ color: var(--muted); font-size: 12px; }
    .tablelike .v{ color: var(--text); font-size: 13px; }
  </style>
</head>

<body>
  <div class="wrap">

    <header>
      <div class="top">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>VT2GO</h1>
            <p class="claim">Power Distribution für Events. Leitungsdimensionierung, Unterverteilungen und sichere Stromversorgung für Bühne, FOH und Backline.</p>
          </div>
        </div>

        <div class="chips">
          <div class="chip">Bühnenstrom</div>
          <div class="chip">Unterverteilungen</div>
          <div class="chip">Lastberechnung</div>
          <div class="chip">Spannungsfall</div>
          <div class="chip">Mobilbetrieb</div>
        </div>
      </div>

      <div class="nav">
        <a class="btn" href="#grundlagen">Grundlagen</a>
        <a class="btn" href="#rechner">Rechner</a>
        <a class="btn" href="#verlegebedingungen">Verlegebedingungen</a>
        <a class="btn" href="#spannungsfall">Spannungsfall</a>
      </div>
    </header>

    <main>

      <section id="grundlagen" class="grid-2">
        <div>
          <h2>Grundlagen</h2>
          <p>
            VT2GO plant elektrische Versorgungen für Veranstaltungstechnik von der Einspeisung bis zur Unterverteilung am Verbraucher.
            Ziel der Leitungsdimensionierung ist eine Leitungsauswahl, die unter realen Eventbedingungen zuverlässig funktioniert:
            passende Absicherung, ausreichende Strombelastbarkeit und ein zulässiger Spannungsfall.
          </p>

          <div class="callout">
            <p class="muted" style="margin:0;">
              <strong>VT2GO-Standard:</strong> Ein Querschnitt ist erst dann freigegeben, wenn die Nennstromregel
              und der Spannungsfall erfüllt sind – unter Berücksichtigung von Temperatur, Häufung und Trommelbetrieb.
            </p>
          </div>

          <ul class="list">
            <li>Last erfassen: \(P\), \(U\), \(\cos\varphi\)</li>
            <li>Betriebsstrom \(I_B\) bestimmen</li>
            <li>Schutzeinrichtung \(I_N\) festlegen</li>
            <li>Korrekturfaktoren anwenden → erforderliche Tabellen-Strombelastbarkeit \(I_r\)</li>
            <li>Querschnitt über \(I_r\) auswählen</li>
            <li>Spannungsfall \(\Delta u\) prüfen</li>
          </ul>

          <div class="kpi">
            <div class="box">
              <p class="title">Spannungsfall-Grenzwert</p>
              <p class="value">Planung häufig 5&nbsp;% (hier im Rechner frei einstellbar)</p>
            </div>
            <div class="box">
              <p class="title">Mobilbetrieb</p>
              <p class="value">Trommel/Lagen + Häufung reduzieren \(I_Z\) massiv</p>
            </div>
          </div>
        </div>

        <div class="hero">
          <img src="images/buehne.png" alt="Beispiel Bühnenaufbau mit Unterverteilungen">
          <div class="caption">Bühnenaufbau: Hauptverteilung mit UVs für Licht, Ton und Steuerung (Beispieldarstellung)</div>
        </div>
      </section>

      <!-- =========================
           NEU: RECHNER
      ========================== -->
      <section id="rechner">
        <h2>Rechner: Leitungsdimensionierung (VT-Praxis)</h2>
        <p class="muted">
          Der Rechner bildet das Tabellenprinzip ab: \(I_B \rightarrow I_N \rightarrow I_r \rightarrow A\) und anschließend Spannungsfallprüfung.
          Standardwerte sind so gesetzt, dass du damit die Beispielaufgabe (2 aktive PA, 40&nbsp;m, 40&nbsp;°C, 3 Leitungen einlagig, 2 Trommellagen, CEE 16&nbsp;A) direkt durchrechnen kannst.
        </p>

        <div class="formgrid">
          <div class="field">
            <label>System</label>
            <select id="sys">
              <option value="1p">Wechselstrom 1~ (230 V)</option>
              <option value="3p">Drehstrom 3~ (400 V)</option>
              <option value="dc">Gleichstrom ⎓</option>
            </select>
          </div>

          <div class="field">
            <label>Anzahl Verbraucher</label>
            <input id="nLoad" type="number" min="1" step="1" value="2">
          </div>

          <div class="field">
            <label>Wirkleistung je Verbraucher \(P\) in W</label>
            <input id="pEach" type="number" min="0" step="1" value="1250">
          </div>

          <div class="field">
            <label>Spannung \(U\) in V</label>
            <input id="u" type="number" min="1" step="1" value="230">
          </div>

          <div class="field">
            <label>Leistungsfaktor \(\cos\varphi\)</label>
            <input id="cosphi" type="number" min="0" max="1" step="0.01" value="0.90">
          </div>

          <div class="field">
            <label>Leitungslänge \(l\) (einfache Strecke) in m</label>
            <input id="len" type="number" min="0" step="0.1" value="40">
          </div>

          <div class="field">
            <label>Schutzeinrichtung \(I_N\)</label>
            <select id="InMode">
              <option value="cee16">CEE 16 A (fix)</option>
              <option value="auto">Auto: nächsthöhere Normstufe ≥ \(I_B\)</option>
              <option value="manual">Manuell wählen</option>
            </select>
          </div>

          <div class="field">
            <label>Manuell: \(I_N\) in A (nur wenn „Manuell“)</label>
            <input id="InManual" type="number" min="1" step="1" value="16" disabled>
          </div>

          <div class="field">
            <label>Zulässiger Spannungsfall \(\Delta u_{\max}\) in %</label>
            <input id="duMax" type="number" min="0" step="0.1" value="5">
          </div>

          <div class="field">
            <label>Leitung (Tabelle Strombelastbarkeit)</label>
            <select id="tableType">
              <option value="hh">Flexible Leitungen – Haus/Handgeräte</option>
              <option value="other">Flexible Leitungen – alle anderen Anwendungen</option>
            </select>
          </div>

          <div class="field">
            <label>Belastete Adern</label>
            <select id="cores">
              <option value="2" selected>2 (L + N)</option>
              <option value="3">3 (L1 + L2 + L3)</option>
            </select>
          </div>

          <div class="field">
            <label>Isolierstoff / zul. Betriebstemperatur</label>
            <select id="insul">
              <option value="gummi60" selected>Gummi (60 °C)</option>
              <option value="pvc70">PVC/PE (70 °C)</option>
            </select>
          </div>

          <div class="field">
            <label>Umgebungstemperatur</label>
            <select id="temp">
              <option value="20">20 °C</option>
              <option value="30">30 °C</option>
              <option value="35">35 °C</option>
              <option value="40" selected>40 °C</option>
              <option value="45">45 °C</option>
              <option value="50">50 °C</option>
            </select>
          </div>

          <div class="field">
            <label>Häufung (Fußboden/Wand)</label>
            <select id="haufType">
              <option value="einlagig" selected>einlagig</option>
              <option value="gebuendelt">gebündelt</option>
            </select>
          </div>

          <div class="field">
            <label>Anzahl parallel verlegter Leitungen (Häufung)</label>
            <input id="haufN" type="number" min="1" max="10" step="1" value="3">
          </div>

          <div class="field">
            <label>Trommelbetrieb: Anzahl Lagen (aufgewickelt)</label>
            <select id="layers">
              <option value="0">keine / vollständig abgerollt</option>
              <option value="1">1 Lage</option>
              <option value="2" selected>2 Lagen</option>
              <option value="3">3 Lagen</option>
              <option value="4">4 Lagen</option>
              <option value="5">5 Lagen</option>
            </select>
          </div>

          <div class="field">
            <label>Leitermaterial (für Spannungsfall über \(\kappa\))</label>
            <select id="material">
              <option value="cu57" selected>Kupfer (E-Cu) \(\kappa = 57\)</option>
              <option value="al3597">Aluminium \(\kappa = 35{,}97\)</option>
            </select>
          </div>
        </div>

        <div class="actions">
          <button class="action-btn" id="btnCalc">Berechnen</button>
          <button class="action-btn" id="btnFillExample">Beispielwerte laden (Aufgabe 1)</button>
          <button class="action-btn" id="btnReset">Zurücksetzen</button>
        </div>

        <div class="resultgrid">
          <div>
            <div id="statusBox" class="status">
              <h3 style="margin:0 0 6px;">Ergebnis</h3>
              <div class="small" id="statusText">Noch keine Berechnung.</div>
            </div>

            <div class="hr"></div>

            <h3>Rechenweg (Schritt für Schritt)</h3>
            <div id="steps" class="formula">
              <span class="muted">Nach „Berechnen“ erscheint hier der vollständige Rechenweg mit Formeln.</span>
            </div>
          </div>

          <div>
            <h3>Kurzwerte</h3>
            <div class="tablelike" id="quick">
              <div class="row"><div class="k">Betriebsstrom \(I_B\)</div><div class="v mono" id="qIb">–</div></div>
              <div class="row"><div class="k">Schutz \(I_N\)</div><div class="v mono" id="qIn">–</div></div>
              <div class="row"><div class="k">Faktorprodukt \(f\)</div><div class="v mono" id="qF">–</div></div>
              <div class="row"><div class="k">Erforderlich \(I_r\)</div><div class="v mono" id="qIr">–</div></div>
              <div class="row"><div class="k">Querschnitt \(A\)</div><div class="v mono" id="qA">–</div></div>
              <div class="row"><div class="k">Spannungsfall \(\Delta u\)</div><div class="v mono" id="qDu">–</div></div>
            </div>
            <p class="muted" style="margin-top:10px;">
              Hinweis: Tabellenwerte gelten als Referenz (hier: Umgebung 30&nbsp;°C gemäß Tabelle Strombelastbarkeit).
              Abweichungen werden über die Korrekturfaktoren berücksichtigt.
            </p>
          </div>
        </div>
      </section>

      <!-- =========================
           DEIN BESTEHENDER CONTENT
      ========================== -->

      <section id="stromarten-nennstromregel" class="stack">
        <h2>Nennstromregel, Scheinleistung und Betriebsstrom</h2>
        <p>
          Grundlage jeder Leitungsdimensionierung ist die <strong>Nennstromregel</strong>. Sie stellt sicher, dass
          Verbraucher, Absicherung und Leitung zueinander passen:
        </p>
        <div class="formula">$$ I_B \le I_N \le I_Z $$</div>
        <p class="muted">
          \(I_B\): Strom im Normalbetrieb &nbsp;–&nbsp;
          \(I_N\): Bemessungsstrom der Sicherung/Steckvorrichtung &nbsp;–&nbsp;
          \(I_Z\): zulässiger Dauerstrom der Leitung unter realen Bedingungen.
        </p>
      </section>

      <section id="verlegebedingungen" class="grid-2">
        <div class="hero">
          <img src="images/kabelbildgut.png" alt="Unterverteilung in der Veranstaltungstechnik">
          <div class="caption">Unterverteilung: RCD, LS, Einspeisung und Abgänge (Beispieldarstellung)</div>
        </div>

        <div>
          <h2>Zulässige Strombelastbarkeit \(I_Z\): Einfluss von Verlegebedingungen und Korrekturfaktoren</h2>
          <p>
            Tabellenwerte gelten unter Referenzbedingungen. Im Veranstaltungsbetrieb weichen die realen Verlegebedingungen
            häufig davon ab. Daher werden Korrekturfaktoren angewendet:
          </p>
          <div class="formula">$$ I_Z = I_{r}\cdot f_T \cdot f_H \cdot f_{Tr} $$</div>
          <p class="muted">
            \(I_r\): Tabellenwert (Referenz) &nbsp;–&nbsp;
            \(f_T\): Temperaturfaktor &nbsp;–&nbsp;
            \(f_H\): Häufungsfaktor &nbsp;–&nbsp;
            \(f_{Tr}\): Trommelfaktor (aufgewickelt).
          </p>
        </div>

        <div class="grid-full" id="verlegebeispiel-2">
          <h3>Beispielhafter Anwendungsfall (ungünstige Verlegebedingungen)</h3>
          <p class="muted">
            Genau diesen Fall kannst du im Rechner oben nachbilden (40&nbsp;°C, Häufung, Trommelbetrieb).
            Entscheidend ist: Das Faktorprodukt kann die zulässige Strombelastbarkeit deutlich reduzieren.
          </p>
        </div>
      </section>

      <section id="spannungsfall">
        <h2>Spannungsfall \(\Delta U\)</h2>
        <p>
          Der Spannungsfall ist eine Funktionsanforderung: Am Verbraucher muss ausreichend Spannung ankommen,
          damit Licht-, Ton- und Steuerungstechnik stabil arbeitet.
        </p>

        <div class="callout">
          <p class="muted" style="margin:0;">
            <strong>Planungsgrenze:</strong> In vielen Anwendungen wird \(\Delta u \le 5\%\) angesetzt.
          </p>
        </div>

        <h3>Formeln</h3>

        <div class="two-cards">
          <div>
            <h3>Wechselstrom (1~)</h3>
            <div class="formula">$$ \Delta U=\frac{2\cdot l\cdot I\cdot \cos\varphi}{\kappa\cdot A} $$</div>
          </div>
          <div>
            <h3>Gleichstrom (⎓)</h3>
            <div class="formula">$$ \Delta U=\frac{2\cdot l\cdot I}{\kappa\cdot A} $$</div>
          </div>
        </div>

        <div style="margin-top:14px;">
          <h3>Drehstrom (3~)</h3>
          <div class="formula">$$ \Delta U=\frac{\sqrt{3}\cdot l\cdot I\cdot \cos\varphi}{\kappa\cdot A} $$</div>
        </div>

        <h3>Bewertung</h3>
        <div class="formula">$$ \Delta u=\frac{\Delta U}{U_N}\cdot 100\% $$</div>
      </section>

      <section>
        <h2>Fazit</h2>
        <p>
          VT2GO dimensioniert Leitungen so, dass Absicherung, Strombelastbarkeit und Spannungsfall unter realen Verlegebedingungen zusammenpassen.
        </p>
      </section>

    </main>

    <footer>
      © VT2GO – Veranstaltungstechnik | Power Distribution & Engineering
    </footer>

  </div>

  <script>
    // ============================
    // Tabellen (aus deinen Bildern / Tabellenprinzip)
    // ============================

    // Normstufen für In (vereinfacht)
    const IN_STEPS = [6,10,13,16,20,25,32,40,50,63];

    // Temperaturfaktoren (UmgebungsT) bezogen auf 30°C = 1 (wie in deiner Tabelle)
    // Gummi (zul. Betriebstemperatur 60°C)
    const TEMP_FACTORS_GUMMI60 = {20:1.15, 30:1.00, 35:0.91, 40:0.82, 45:0.71, 50:0.58};
    // PVC/PE (zul. Betriebstemperatur 70°C)
    const TEMP_FACTORS_PVC70   = {20:1.12, 30:1.00, 35:0.94, 40:0.87, 45:0.79, 50:0.71};

    // Häufung auf Fußboden/Wand: Faktoren nach Anzahl Leitungen (1..10)
    const HAUF_EINLAGIG = {1:1.00,2:0.85,3:0.79,4:0.75,5:0.73,6:0.72,7:0.72,8:0.71,9:0.70,10:0.70};
    const HAUF_GEBUENDELT = {1:1.00,2:0.80,3:0.70,4:0.65,5:0.60,6:0.57,7:0.54,8:0.52,9:0.50,10:0.48};

    // Aufgewickelte Leitungen (Trommel/Spule): Faktor nach Lagen
    const TROMMEL = {0:1.00, 1:0.80, 2:0.61, 3:0.49, 4:0.42, 5:0.38};

    // Strombelastbarkeitstabelle (Referenz) – flexible Leitungen bei Verlegung auf/ an Flächen, Umgebung 30°C
    // Zwei Tabellenoptionen:
    // hh = "Haus- und Handgeräte" (dein Fall in der Aufgabe; 6mm² -> 40A bei 2 belasteten Adern)
    // other = "alle anderen Anwendungen"
    const IZ_TABLES = {
      hh: {
        "2": {0.75:6, 1:10, 1.5:16, 2.5:25, 4:32, 6:40, 10:63},
        "3": {0.75:6, 1:10, 1.5:16, 2.5:20, 4:25}
      },
      other: {
        // gilt für 2 oder 3 stromführende Adern (laut Tabelle)
        "2": {0.75:12, 1:15, 1.5:18, 2.5:26, 4:34, 6:44, 10:61, 16:82, 25:108, 35:135, 50:168},
        "3": {0.75:12, 1:15, 1.5:18, 2.5:26, 4:34, 6:44, 10:61, 16:82, 25:108, 35:135, 50:168}
      }
    };

    function round2(x){ return Math.round(x*100)/100; }
    function round3(x){ return Math.round(x*1000)/1000; }

    function getTempFactor(insul, temp){
      const t = Number(temp);
      if(insul === "gummi60") return TEMP_FACTORS_GUMMI60[t] ?? 1.00;
      return TEMP_FACTORS_PVC70[t] ?? 1.00;
    }

    function getHaufFactor(type, n){
      const nn = Math.max(1, Math.min(10, Number(n)));
      return (type === "gebuendelt" ? HAUF_GEBUENDELT[nn] : HAUF_EINLAGIG[nn]) ?? 1.00;
    }

    function nextInStep(ib){
      for(const s of IN_STEPS){
        if(s >= ib) return s;
      }
      return IN_STEPS[IN_STEPS.length-1];
    }

    function pickCrossSection(tableKey, cores, requiredIr){
      const table = IZ_TABLES[tableKey]?.[String(cores)];
      if(!table) return {A:null, Ir:null, note:"Für diese Tabellenwahl sind keine Werte hinterlegt."};

      const entries = Object.entries(table)
        .map(([A, Ir]) => ({A:Number(A), Ir:Number(Ir)}))
        .sort((a,b)=>a.A-b.A);

      for(const e of entries){
        if(e.Ir >= requiredIr) return {A:e.A, Ir:e.Ir, note:""};
      }
      return {A:null, Ir:null, note:"Kein Querschnitt in dieser Tabelle erfüllt die Anforderung."};
    }

    function computeIb(sys, Pges, U, cosphi){
      if(sys === "dc"){
        return Pges / U;
      }
      if(sys === "3p"){
        // Drehstrom über Wirkleistung P: I = P/(sqrt(3)*U*cosφ)
        return Pges / (Math.sqrt(3)*U*cosphi);
      }
      // 1~
      return Pges / (U*cosphi);
    }

    function computeDeltaU(sys, l, I, cosphi, kappa, A){
      if(A <= 0) return NaN;
      if(sys === "dc"){
        return (2*l*I) / (kappa*A);
      }
      if(sys === "3p"){
        return (Math.sqrt(3)*l*I*cosphi) / (kappa*A);
      }
      // 1~
      return (2*l*I*cosphi) / (kappa*A);
    }

    // ============================
    // UI Wiring
    // ============================

    const el = (id)=>document.getElementById(id);

    function setExample(){
      el("sys").value = "1p";
      el("nLoad").value = 2;
      el("pEach").value = 1250;
      el("u").value = 230;
      el("cosphi").value = 0.90;
      el("len").value = 40;

      el("InMode").value = "cee16";
      el("InManual").value = 16; el("InManual").disabled = true;

      el("duMax").value = 5;

      el("tableType").value = "hh";
      el("cores").value = "2";

      el("insul").value = "gummi60";
      el("temp").value = "40";

      el("haufType").value = "einlagig";
      el("haufN").value = 3;

      el("layers").value = 2;
      el("material").value = "cu57";
    }

    function resetAll(){
      setExample();
      setStatus("status", "Noch keine Berechnung.", "");
      el("steps").innerHTML = '<span class="muted">Nach „Berechnen“ erscheint hier der vollständige Rechenweg mit Formeln.</span>';
      ["qIb","qIn","qF","qIr","qA","qDu"].forEach(id=>el(id).textContent="–");
      if(window.MathJax) MathJax.typesetPromise();
    }

    function setStatus(kind, text, detail){
      const box = el("statusBox");
      box.classList.remove("ok","warn","bad");
      if(kind === "ok") box.classList.add("ok");
      else if(kind === "warn") box.classList.add("warn");
      else if(kind === "bad") box.classList.add("bad");
      el("statusText").innerHTML = `<div>${text}</div>${detail ? `<div class="small" style="margin-top:6px;">${detail}</div>` : ""}`;
    }

    el("InMode").addEventListener("change", ()=>{
      const mode = el("InMode").value;
      el("InManual").disabled = (mode !== "manual");
    });

    function calc(){
      const sys = el("sys").value;
      const nLoad = Number(el("nLoad").value);
      const pEach = Number(el("pEach").value);
      const U = Number(el("u").value);
      const cosphi = Number(el("cosphi").value);
      const l = Number(el("len").value);

      const InMode = el("InMode").value;
      const InManual = Number(el("InManual").value);

      const duMax = Number(el("duMax").value);

      const tableType = el("tableType").value;
      const cores = Number(el("cores").value);

      const insul = el("insul").value;
      const temp = Number(el("temp").value);

      const haufType = el("haufType").value;
      const haufN = Number(el("haufN").value);

      const layers = Number(el("layers").value);
      const material = el("material").value;

      const kappa = (material === "al3597") ? 35.97 : 57;

      // 1) Leistung + Betriebsstrom
      const Pges = nLoad * pEach;
      const Ib = computeIb(sys, Pges, U, cosphi);

      // 2) In bestimmen
      let In;
      let InExplain = "";
      if(InMode === "cee16"){
        In = 16;
        InExplain = "CEE 16 A (fix)";
      } else if(InMode === "auto"){
        In = nextInStep(Ib);
        InExplain = `Auto: nächsthöhere Normstufe ≥ I_B`;
      } else {
        In = InManual;
        InExplain = "Manuell";
      }

      // 3) Faktoren
      const fT = getTempFactor(insul, temp);
      const fH = getHaufFactor(haufType, haufN);
      const fTr = TROMMEL[layers] ?? 1.0;

      const f = fT * fH * fTr;

      // 4) Erforderliche Tabellen-Strombelastbarkeit Ir
      // Aus I_Z = I_r * f  und Forderung I_Z >= I_N folgt: I_r >= I_N / f
      const IrReq = In / f;

      // 5) Querschnitt wählen über Tabelle
      const pick = pickCrossSection(tableType, cores, IrReq);

      // 6) Spannungsfall prüfen (mit gewähltem A; wenn nicht vorhanden -> kein Check)
      let dU = NaN, du = NaN;
      if(pick.A){
        dU = computeDeltaU(sys, l, Ib, cosphi, kappa, pick.A);
        du = (dU / U) * 100;
      }

      // 7) Statuslogik
      const nennstromOk = Ib <= In;
      const querschnittOk = pick.A !== null;
      const spannungsOk = (pick.A !== null) ? (du <= duMax) : false;

      // Quick values
      el("qIb").textContent = `${round2(Ib)} A`;
      el("qIn").textContent = `${In} A (${InExplain})`;
      el("qF").textContent = `${round3(f)} (= ${round2(fT)} · ${round2(fH)} · ${round2(fTr)})`;
      el("qIr").textContent = `${round2(IrReq)} A (erforderlich)`;
      el("qA").textContent = pick.A ? `${pick.A} mm² (I_r=${pick.Ir} A)` : `–`;
      el("qDu").textContent = pick.A ? `${round2(du)} % (ΔU=${round2(dU)} V)` : `–`;

      // Step-by-step rendering (MathJax)
      const sysLabel = (sys==="1p") ? "Wechselstrom (1~)" : (sys==="3p") ? "Drehstrom (3~)" : "Gleichstrom (⎓)";
      const haufLabel = (haufType==="einlagig") ? "einlagig" : "gebündelt";

      const formulaIb = (sys==="dc")
        ? `I_B=\\frac{P_{ges}}{U}`
        : (sys==="3p")
          ? `I_B=\\frac{P_{ges}}{\\sqrt{3}\\,U\\,\\cos\\varphi}`
          : `I_B=\\frac{P_{ges}}{U\\,\\cos\\varphi}`;

      const duFormula = (sys==="dc")
        ? `\\Delta U=\\frac{2\\,l\\,I}{\\kappa\\,A}`
        : (sys==="3p")
          ? `\\Delta U=\\frac{\\sqrt{3}\\,l\\,I\\,\\cos\\varphi}{\\kappa\\,A}`
          : `\\Delta U=\\frac{2\\,l\\,I\\,\\cos\\varphi}{\\kappa\\,A}`;

      const stepsHTML = `
        <div class="small">System: <span class="mono">${sysLabel}</span></div>
        <hr class="hr">
        <div><strong>1) Gesamtwirkleistung</strong></div>
        <div class="mono">Pges = n · P = ${nLoad} · ${pEach} W = ${Pges} W</div>

        <div class="hr"></div>
        <div><strong>2) Betriebsstrom</strong></div>
        <div>$$ ${formulaIb} $$</div>
        <div class="mono">I_B = ${round2(Ib)} A</div>

        <div class="hr"></div>
        <div><strong>3) Schutzeinrichtung</strong></div>
        <div>$$ I_B \\le I_N $$</div>
        <div class="mono">I_N = ${In} A (${InExplain})</div>
        <div class="mono">${nennstromOk ? "OK" : "NICHT OK"}: ${round2(Ib)} ≤ ${In}</div>

        <div class="hr"></div>
        <div><strong>4) Korrekturfaktoren (Strombelastbarkeit)</strong></div>
        <div class="mono">Temperatur: f_T = ${fT} (${insul==="gummi60" ? "Gummi 60°C" : "PVC/PE 70°C"}, ${temp}°C)</div>
        <div class="mono">Häufung: f_H = ${fH} (${haufLabel}, ${Math.max(1,Math.min(10,haufN))} Leitungen)</div>
        <div class="mono">Trommel: f_Tr = ${fTr} (${layers===0 ? "abgerollt" : layers+" Lagen"})</div>
        <div>$$ f = f_T \\cdot f_H \\cdot f_{Tr} = ${round3(f)} $$</div>

        <div class="hr"></div>
        <div><strong>5) Erforderliche Tabellen-Strombelastbarkeit</strong></div>
        <div>$$ I_Z = I_r \\cdot f \\quad\\Rightarrow\\quad I_r \\ge \\frac{I_N}{f} $$</div>
        <div class="mono">I_r,erf = ${In} / ${round3(f)} = ${round2(IrReq)} A</div>

        <div class="hr"></div>
        <div><strong>6) Querschnittsauswahl über Tabelle</strong></div>
        <div class="mono">Tabelle: ${tableType==="hh" ? "Flexible Leitungen – Haus/Handgeräte" : "Flexible Leitungen – alle anderen Anwendungen"}</div>
        <div class="mono">Belastete Adern: ${cores}</div>
        <div class="mono">
          ${pick.A ? `Auswahl: A = ${pick.A} mm² (I_r=${pick.Ir} A) ≥ ${round2(IrReq)} A` : `Keine passende Auswahl. ${pick.note}`}
        </div>

        <div class="hr"></div>
        <div><strong>7) Spannungsfallprüfung</strong></div>
        <div class="mono">κ = ${kappa} m/(Ω·mm²)</div>
        <div>$$ ${duFormula} $$</div>
        ${pick.A ? `
          <div class="mono">ΔU = ${round2(dU)} V</div>
          <div>$$ \\Delta u = \\frac{\\Delta U}{U}\\cdot 100\\% $$</div>
          <div class="mono">Δu = ${round2(du)} %  (Grenze: ${duMax} %)</div>
        ` : `<div class="mono">Spannungsfall nicht berechnet (kein Querschnitt ausgewählt).</div>`}
      `;

      el("steps").innerHTML = stepsHTML;

      // Gesamtstatus
      if(!nennstromOk){
        setStatus("bad", "Nennstromregel verletzt: Schutzorgan ist zu klein.", "Passe \(I_N\) an oder reduziere die Last.");
      } else if(!querschnittOk){
        setStatus("bad", "Kein Querschnitt gefunden (Strombelastbarkeit).", "Wähle eine andere Tabelle/Verlegeannahme oder erhöhe \(A\) außerhalb dieser Tabelle.");
      } else if(!spannungsOk){
        setStatus("warn", "Strombelastbarkeit OK, aber Spannungsfall zu hoch.", "Erhöhe den Querschnitt oder reduziere die Leitungslänge.");
      } else {
        setStatus("ok", "Dimensionierung OK: Nennstromregel, Strombelastbarkeit und Spannungsfall erfüllt.", `Ergebnis: ${pick.A} mm² bei Δu=${round2(du)} %.`);
      }

      // MathJax render
      if(window.MathJax) MathJax.typesetPromise();
    }

    el("btnCalc").addEventListener("click", calc);
    el("btnFillExample").addEventListener("click", ()=>{ setExample(); calc(); });
    el("btnReset").addEventListener("click", resetAll);

    // Initial
    setExample();
  </script>

</body>
</html>
